(function(R,o,c,A,n,J,X,m,N,p,f,D,Y){"use strict";const _="915703782174752809",g="https://manti.vendicated.dev",v=g+"/api/reviewdb";var H=Object.freeze({__proto__:null,API_URL:v,BASE_URL:g,CLIENT_ID:_}),T,E;const{getCurrentUser:P}=c.findByStoreName("UserStore"),G=((T=find(function(e){var t,r;return(r=e.default)===null||r===void 0||(t=r.internal)===null||t===void 0?void 0:t.resolveSemanticColor}))===null||T===void 0?void 0:T.default.internal.resolveSemanticColor)??((E=find(function(e){var t;return(t=e.meta)===null||t===void 0?void 0:t.resolveSemanticColor}))===null||E===void 0?void 0:E.meta.resolveSemanticColor)??function(){},{useThemeContext:W}=c.findByProps("useThemeContext"),B=function(e){var t,r;return e.sender.discordID===((t=P())===null||t===void 0?void 0:t.id)||b.includes((r=P())===null||r===void 0?void 0:r.id)};async function d(e,t){const r=await(await fetch(e,{headers:{"content-type":"application/json",accept:"application/json"},...t})).json();if(r.success===!1)throw new Error(r.message);return r}const w=function(e){var t;return G(((t=W())===null||t===void 0?void 0:t.theme)??"dark",A.semanticColors[e])};var q=Object.freeze({__proto__:null,canDeleteReview:B,jsonFetch:d,useThemedColor:w});const x=async function(e){return(await d(v+`/users/${e}/reviews`)).reviews},k=async function(){return await d(g+"/admins")},U=async function(e,t){return await d(v+`/users/${e}/reviews`,{method:"PUT",body:JSON.stringify({comment:t,token:o.storage.authToken})})},L=async function(e,t){return await d(v+`/users/${e}/reviews`,{method:"DELETE",body:JSON.stringify({reviewid:t,token:o.storage.authToken})})},$=async function(e){return await d(v+"/reports",{method:"PUT",body:JSON.stringify({reviewid:e,token:o.storage.authToken})})};var K=Object.freeze({__proto__:null,addReview:U,deleteReview:L,getAdmins:k,getCurrentUser:async function(){return await d(v+"/users",{method:"POST",body:JSON.stringify({token:o.storage.authToken})})},getReviews:x,reportReview:$});const{hideActionSheet:Q}=c.findByProps("openLazy","hideActionSheet"),{showSimpleActionSheet:Z}=c.findByProps("showSimpleActionSheet");function F(e){return Z({key:"ReviewOverflow",header:{title:e.type!==3?`Review by ${e.sender.username}`:"ReviewDB System Message",onClose:function(){return Q()}},options:[{label:"Copy Text",onPress:function(){n.clipboard.setString(e.comment),p.showToast("Copied Review Text",f.getAssetIDByName("ic_message_copy"))}},...o.storage.authToken&&e.type!==3?[...B(e)?[{label:"Delete Review",isDestructive:!0,onPress:function(){return N.showConfirmationAlert({title:"Delete Review",content:"Are you sure you want to delete this review?",confirmText:"Yes",cancelText:"No",confirmColor:"red",onConfirm:function(){return L(e.sender.discordID,e.id)}})}}]:[],{label:"Report Review",isDestructive:!0,onPress:function(){return N.showConfirmationAlert({title:"Report Review",content:"Are you sure you want to report this review?",confirmText:"Yes",cancelText:"No",confirmColor:"red",onConfirm:function(){return $(e.id)}})}}]:[]]})}function ee(e){let{badge:t}=e;return React.createElement(n.ReactNative.Pressable,{style:{marginLeft:4},onPress:function(){p.showToast(t.name,{uri:t.icon})}},React.createElement(n.ReactNative.Image,{source:{uri:t.icon,width:16,height:16}}))}const O=n.stylesheet.createThemedStyleSheet({row:{flexDirection:"row",alignItems:"center"}}),{FormLabel:te}=m.Forms;function ne(e){let{username:t,badges:r}=e;return React.createElement(n.ReactNative.View,{style:O.row},React.createElement(te,{text:t,style:{color:w("TEXT_NORMAL")}}),React.createElement(n.ReactNative.View,{style:O.row},r.map(function(i){return React.createElement(ee,{badge:i})})))}const re=n.stylesheet.createThemedStyleSheet({avatar:{height:36,width:36,borderRadius:18}}),{FormRow:oe,FormSubLabel:ae}=m.Forms;function ie(e){let{review:t}=e;return React.createElement(oe,{label:React.createElement(ne,{username:t.sender.username,badges:t.sender.badges}),subLabel:React.createElement(ae,{text:t.comment,style:{color:w("TEXT_NORMAL")}}),leading:React.createElement(n.ReactNative.Image,{style:re.avatar,source:{uri:t.sender.profilePhoto}}),onLongPress:function(){return F(t)}})}const S=n.stylesheet.createThemedStyleSheet({container:{flex:1,flexDirection:"row",alignItems:"center",justifyContent:"center",paddingHorizontal:8,paddingVertical:4},textInput:{flex:1,flexGrow:1,fontSize:16,fontFamily:n.constants.Fonts.DISPLAY_MEDIUM},sendButton:{flexShrink:1,flexDirection:"row",alignItems:"center",justifyContent:"center",minHeight:40,minWidth:40,borderRadius:999}}),{useThemeContext:se}=c.findByProps("useThemeContext");function ce(e){let{userId:t,shouldEdit:r,refetch:i}=e;D.useProxy(o.storage);const[a,h]=n.React.useState(""),l=!o.storage.authToken,s=!o.storage.authToken||a.length===0;return n.React.createElement(n.ReactNative.View,{style:S.container},n.React.createElement(n.ReactNative.TextInput,{style:{...S.textInput,color:w("TEXT_NORMAL")},editable:!l,placeholder:l?"You must be authenticated to add a review.":`Tap to ${r?"edit your":"add a"} review`,placeholderTextColor:w("INPUT_PLACEHOLDER_TEXT"),value:a,onChangeText:function(u){return h(u)}}),n.React.createElement(n.ReactNative.Pressable,{style:{...S.sendButton,backgroundColor:o.storage.useThemedSend&&se().primaryColor||A.rawColors.BRAND_500,opacity:s?.25:1},disabled:s,onPress:function(){U(t,a).then(function(u){h(""),i(),p.showToast(u.message,f.getAssetIDByName("Check"))}).catch(function(u){return p.showToast(u.message,f.getAssetIDByName("Small"))})}},n.React.createElement(n.ReactNative.Image,{style:{tintColor:"#fff"},source:f.getAssetIDByName("ic_send")})))}const{getCurrentUser:le}=c.findByStoreName("UserStore"),ue=c.findByName("UserProfileSection");function de(e){let{userId:t}=e;const[r,i]=n.React.useState([]),a=function(){x(t).then(function(l){return i(l)})};n.React.useEffect(a,[]);const h=r.filter(function(l){var s;return l.sender.discordID===((s=le())===null||s===void 0?void 0:s.id)}).length!==0;return n.React.createElement(m.ErrorBoundary,null,n.React.createElement(ue,{title:"Reviews",showContainer:!0},n.React.createElement(n.ReactNative.View,{style:{flex:1}},r.map(function(l){return n.React.createElement(ie,{review:l})})),n.React.createElement(ce,{userId:t,refetch:a,shouldEdit:h})))}const he=c.findByTypeName("UserProfile");function fe(){return J.after("type",he,function(e,t){var r,i,a;const h=(i=X.findInReactTree(t,function(s){var u,C;return(s==null||(u=s.type)===null||u===void 0?void 0:u.displayName)==="View"&&(s==null||(C=s.props)===null||C===void 0?void 0:C.children.findIndex(function(V){var I;return(V==null||(I=V.type)===null||I===void 0?void 0:I.name)==="UserProfileBio"}))!==-1}))===null||i===void 0||(r=i.props)===null||r===void 0?void 0:r.children,l=(a=e[0])===null||a===void 0?void 0:a.userId;h?.push(n.React.createElement(de,{userId:l}))})}const{pushModal:ve,popModal:M}=c.findByProps("pushModal"),ye=c.findByName("OAuth2AuthorizeModal");function z(){return ve({key:"oauth2-authorize",modal:{key:"oauth2-authorize",modal:ye,animation:"slide-up",shouldPersistUnderModals:!1,props:{clientId:_,redirectUri:v+"/auth",scopes:["identify"],responseType:"code",permissions:0n,cancelCompletesFlow:!1,callback:async function(e){let{location:t}=e;try{const r=new URL(t);r.searchParams.append("returnType","json"),r.searchParams.append("clientMod","vendetta");const{token:i,success:a,message:h}=await d(r,{headers:{accept:"application/json"}});if(a)o.storage.authToken=i;else throw M("oauth2-authorize"),new Error(h)}catch(r){Y.logger.error("Authorization failed!",r)}},dismissOAuthModal:function(){return M("oauth2-authorize")}},closable:!0}})}function we(){return globalThis.vendettaRDB={api:K,utils:{...q,showAuthModal:z,showReviewActionSheet:F},constants:H},function(){return delete globalThis.vendettaRDB}}const{FormSection:j,FormRow:y,FormSwitchRow:Re,FormDivider:me}=m.Forms;function pe(){return D.useProxy(o.storage),React.createElement(n.ReactNative.ScrollView,{style:{flex:1},contentContainerStyle:{paddingBottom:38}},React.createElement(j,{title:"Authentication",titleStyleType:"no_border"},React.createElement(y,{label:"Authenticate with ReviewDB",leading:React.createElement(y.Icon,{source:f.getAssetIDByName("copy")}),trailing:y.Arrow,onPress:z}),React.createElement(me,null),React.createElement(y,{label:"Log out of ReviewDB",subLabel:"Note that this does not remove ReviewDB from your Authorized Apps page in Discord.",leading:React.createElement(y.Icon,{source:f.getAssetIDByName("ic_logout_24px")}),disabled:o.storage.authToken.length===0,onPress:function(){return o.storage.authToken=""}})),React.createElement(j,{title:"Settings"},React.createElement(Re,{label:"Use profile-themed send button",subLabel:"Controls whether the review send button should attempt to match the user's profile colors.",leading:React.createElement(y.Icon,{source:f.getAssetIDByName("ic_paint_brush")}),value:o.storage.useThemedSend,onValueChange:function(e){return o.storage.useThemedSend=e}})))}o.storage.authToken??="",o.storage.useThemedSend??=!0;const ge=[we(),fe()],b=[];k().then(function(e){return b.push(...e)});const Te=function(){return ge.forEach(function(e){return e()})};return R.admins=b,R.onUnload=Te,R.settings=pe,R})({},vendetta.plugin,vendetta.metro,vendetta.ui,vendetta.metro.common,vendetta.patcher,vendetta.utils,vendetta.ui.components,vendetta.ui.alerts,vendetta.ui.toasts,vendetta.ui.assets,vendetta.storage,vendetta);
